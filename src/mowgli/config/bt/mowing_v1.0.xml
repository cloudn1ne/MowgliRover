<!--
- 
- Mowgli Mowing v1.0
-
- (c) Georg Swoboda <cn@warp.at> 2022
- https://github.com/cloudn1ne/MowgliRover
-
- *) If currently charging (in Docking Station) we  DriveBackward
- *) We loop MowAreas from 0-99
- *)    We loop MowPaths from 0-99
- *)        For each MowPath we attempt 3 times to get to the first pose of the MowPath
- *)        If we fail to reach the MowPathApproachPoint we strip N poses of the MowPath and retry until we hit the retry limit
- *)        If the MowPathApproachPoint has been reached we will enable the Blade Motor and start following the MowPath
- *) at the end we make sure the Blade Motor is switched off
-->
<root>    
    <BehaviorTree ID="Mowing">        
      <Sequence name="Mowing">
        <Sequence name="seq_EnvVars">
          <GetEnvBool var="OM_ENABLE_MOWER" bool_out="{enable_mower}"/> <!-- blackboard variables are only valid within the same subtree, so we need to pull them in here -->
        </Sequence>
        <SubTree ID="Undocking"/> <!-- undocking_vX.X.xml -->
        <SubTree ID="WaitForOdom"/>
        <ForLoop
          loop_var="{area_index}"
          loop_var_start="0"
          loop_var_until="99"
          increment_by="1"
          name="mowAreas"
        >
            <Sequence name="iterateMowAreas">
                <GetMowPlan area_index="{area_index}" mowplan="{mowplan}"/>
                <ForLoop
                  loop_var="{path_index}"
                  loop_var_start="0"
                  loop_var_until="99"
                  increment_by="1"
                  name="mowPaths"
                > 
                    <Sequence name="iterateMowPaths">  
                      <GetMowPath path_index="{path_index}" mowplan="{mowplan}" path_out="{mowpath}"/>                      
                      <BladeMotorControl enable="0"/> <!-- Disable Blade Motor before and after Mow -->
                      <RetryUntilSuccessful num_attempts="5" name="retry_ApproachFirstPoseOfMowPath">        
                            <Sequence>                                
                                <SubTree ID="WaitForOdom"/> <!-- Wait for /odom to be valid -->
                                <Fallback name="ApproachFirstPoseFallback">
                                    <Sequence name="seq_ApproachFirstPose">         
                                        <GetFirstPose path="{mowpath}" pose_out="{first_pose}"/>
                                        <ApproachPose pose="{first_pose}" planner="FTCPlannerTuning"/>
                                    </Sequence>
                                    <ForceFailure> <!--force next RetryUntilSuccessful attempt, by failing Fallback -->
                                        <TrimPoses path="{mowpath}" begin="0" end="5"/> <!-- we trim 5 poses of the beginning of the mowpath, and reattempt to approach the new first_pose -->
                                    </ForceFailure>
                                </Fallback>
                                <Sequence name="seq_FollowMowPath">                                        
                                        <BladeMotorControl enable="{enable_mower}"/> <!-- Enable Blade Motor for Mow -->
                                        <Fallback name="ApproachFirstPoseFallback">  
                                              <FollowPath path="{mowpath}" planner="FTCPlannerTuning" current_index="{mowpath_index}"/> <!-- Mow -->
                                              <ForceFailure> <!--force next RetryUntilSuccessful attempt, by failing Fallback -->
                                                <TrimPoses path="{mowpath}" begin="0" end="{mowpath_index}"/> <!--  Fallback: Trim already completed poses from the current mowpath -->                                                                                                
                                              </ForceFailure>
                                        </Fallback>                                          
                                        <BladeMotorControl enable="0"/> <!-- Disable Blade Motor after Mow (FollowPath was successfull) -->                                        
                                </Sequence>
                            </Sequence>
                       </RetryUntilSuccessful>                           
                    </Sequence>
                    <SayString message="For iterateMowPaths ended ;-)" />
                </ForLoop>
            </Sequence>
            <SayString message="For iterateMowAreas loop ended ;-)" />
        </ForLoop>
        <BladeMotorControl enable="0"/>      
      </Sequence>    
    </BehaviorTree>
 </root>      